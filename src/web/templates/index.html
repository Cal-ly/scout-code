<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scout - Job Application Generator</title>
    <link rel="stylesheet" href="/static/css/common.css">
    <style>
        /* Dashboard-specific styles */
        .char-count {
            font-size: 0.85rem;
            color: #666;
            margin-top: 0.5rem;
        }
        .char-count.warning {
            color: #d97706;
        }

        /* Progress Bar */
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
            margin: 1rem 0;
        }
        .progress-bar-fill {
            height: 100%;
            background: #2563eb;
            transition: width 0.5s ease;
        }

        /* Steps */
        .steps {
            margin-top: 1.5rem;
        }
        .step {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 0;
        }
        .step-icon {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85rem;
            font-weight: 600;
        }
        .step-pending { background: #e5e7eb; color: #6b7280; }
        .step-running { background: #2563eb; color: #fff; }
        .step-completed { background: #10b981; color: #fff; }
        .step-failed { background: #ef4444; color: #fff; }
        .step-label { color: #374151; }
        .step-label.inactive { color: #9ca3af; }
        .step-duration {
            margin-left: auto;
            font-size: 0.8rem;
            color: #9ca3af;
        }

        /* Result Section */
        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }
        .result-header h3 {
            font-size: 1.25rem;
            color: #1a1a1a;
        }
        .result-header p {
            color: #666;
        }
        .match-message {
            padding: 1rem;
            border-radius: 6px;
            margin: 1rem 0;
        }
        .match-excellent { background: #d1fae5; color: #065f46; }
        .match-strong { background: #dbeafe; color: #1e40af; }
        .match-moderate { background: #fef3c7; color: #92400e; }
        .match-weak { background: #fee2e2; color: #991b1b; }

        .download-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin: 1.5rem 0;
        }
        .btn-download {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 1rem;
            border-radius: 6px;
            text-decoration: none;
            font-weight: 600;
        }
        .btn-cv {
            background: #2563eb;
            color: #fff;
        }
        .btn-cv:hover {
            background: #1d4ed8;
        }
        .btn-cover {
            background: #10b981;
            color: #fff;
        }
        .btn-cover:hover {
            background: #059669;
        }

        /* Error Card */
        .error-card {
            background: #fef2f2;
            border: 1px solid #fecaca;
        }
        .error-card h3 {
            color: #991b1b;
        }
        .error-card p {
            color: #b91c1c;
            margin-top: 0.5rem;
        }

        /* Profile Warning */
        .profile-warning {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 2px solid #f59e0b;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .profile-warning-icon {
            font-size: 2rem;
            flex-shrink: 0;
        }
        .profile-warning-content {
            flex: 1;
        }
        .profile-warning-content h3 {
            color: #92400e;
            font-size: 1.1rem;
            margin-bottom: 0.25rem;
        }
        .profile-warning-content p {
            color: #78350f;
            font-size: 0.9rem;
        }
        .btn-create-profile {
            background: #f59e0b;
            color: #fff;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            text-decoration: none;
            font-weight: 600;
            white-space: nowrap;
            transition: background 0.2s;
        }
        .btn-create-profile:hover {
            background: #d97706;
        }

        /* Profile Status */
        .profile-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
            padding: 0.75rem 1rem;
            background: #d1fae5;
            border-radius: 6px;
            color: #065f46;
            font-size: 0.9rem;
        }
        .profile-status-icon {
            font-size: 1.1rem;
        }
        .profile-status a {
            color: #047857;
            text-decoration: underline;
        }

        /* Profile Override Section */
        .profile-override {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        .profile-override-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }
        .profile-override-header label {
            font-size: 0.9rem;
            color: #374151;
        }
        .profile-override-select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.95rem;
            background: #fff;
        }
        .profile-override-select:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37,99,235,0.1);
        }

        /* Spinner animation */
        .spinner {
            animation: spin 1s linear infinite;
        }

        /* Quick Score Section */
        .quick-score-section {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid #e5e7eb;
        }

        .quick-score-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .btn-quick-score {
            background: #8b5cf6;
            color: #fff;
        }

        .btn-quick-score:hover {
            background: #7c3aed;
        }

        .btn-quick-score:disabled {
            background: #c4b5fd;
            cursor: not-allowed;
        }

        /* Quick Score Results */
        .quick-score-result {
            margin-top: 1rem;
            padding: 1.25rem;
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
        }

        .quick-score-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .quick-score-title h4 {
            font-size: 1.1rem;
            color: #1a1a1a;
            margin: 0;
        }

        .quick-score-title p {
            font-size: 0.9rem;
            color: #666;
            margin: 0.25rem 0 0 0;
        }

        .quick-score-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-top: 1rem;
        }

        .quick-score-list {
            padding: 0.75rem;
            background: #fff;
            border-radius: 6px;
        }

        .quick-score-list h5 {
            font-size: 0.85rem;
            color: #374151;
            margin: 0 0 0.5rem 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .quick-score-list ul {
            margin: 0;
            padding-left: 1.25rem;
            font-size: 0.85rem;
            color: #4b5563;
        }

        .quick-score-list ul li {
            margin-bottom: 0.25rem;
        }

        .quick-score-list.matches h5 { color: #059669; }
        .quick-score-list.gaps h5 { color: #dc2626; }

        .quick-score-recommendation {
            margin-top: 1rem;
            padding: 0.75rem;
            background: #eff6ff;
            border-radius: 6px;
            font-size: 0.9rem;
            color: #1e40af;
        }

        .quick-score-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            padding: 2rem;
            color: #6b7280;
        }

        .btn-clear-score {
            margin-top: 1rem;
            padding: 0.5rem 1rem;
            background: #e5e7eb;
            border: none;
            border-radius: 4px;
            font-size: 0.85rem;
            color: #374151;
            cursor: pointer;
        }

        .btn-clear-score:hover {
            background: #d1d5db;
        }
    </style>
</head>
<body>
    {% include 'partials/navbar.html' %}

    <main class="container container-narrow">
        <!-- Profile Warning Section (shown when no profile exists) -->
        <section id="profile-warning-section" class="profile-warning hidden">
            <div class="profile-warning-icon">&#9888;</div>
            <div class="profile-warning-content">
                <h3>Profile Required</h3>
                <p>Create your professional profile to start matching jobs and generating applications.</p>
            </div>
            <a href="/profile/edit" class="btn-create-profile">Create Profile</a>
        </section>

        <!-- Profile Status Section (shown when profile exists) -->
        <div id="profile-status-section" class="profile-status hidden">
            <span class="profile-status-icon">&#10003;</span>
            <span id="profile-status-text">Profile ready</span>
            <a href="/profiles" id="manage-profiles-link">Manage Profiles</a>
        </div>

        <!-- Input Section -->
        <section id="input-section" class="card">
            <h2>Paste Job Posting</h2>
            <textarea
                id="job-text"
                placeholder="Paste the full job posting text here...

Include:
- Job title
- Company name
- Requirements
- Responsibilities
- Qualifications"
            ></textarea>
            <p class="char-count" id="char-count">0 characters</p>

            <!-- Profile Override Section -->
            <div class="profile-override" id="profile-override-section">
                <div class="profile-override-header">
                    <label for="profile-select">Using Profile:</label>
                </div>
                <select id="profile-select" class="profile-override-select">
                    <option value="">Use active profile (default)</option>
                    <!-- Options populated dynamically -->
                </select>
            </div>

            <div class="quick-score-buttons" style="margin-top: 1rem;">
                <button id="quick-score-btn" class="btn btn-quick-score" disabled>
                    Quick Score
                </button>
                <button id="submit-btn" class="btn btn-primary" disabled>
                    Generate Application
                </button>
            </div>

            <!-- Quick Score Result -->
            <div id="quick-score-container" class="hidden">
                <div id="quick-score-loading" class="quick-score-result quick-score-loading hidden">
                    <span class="spinner">&#8635;</span>
                    <span id="quick-score-loading-text">Analyzing compatibility... (timeout: 5:00)</span>
                </div>
                <div id="quick-score-result" class="quick-score-result hidden">
                    <div class="quick-score-header">
                        <div class="quick-score-title">
                            <h4 id="qs-job-title">Job Title</h4>
                            <p id="qs-company">Company Name</p>
                        </div>
                        <div class="score-badge" id="qs-score-badge">85%</div>
                    </div>
                    <div class="quick-score-details">
                        <div class="quick-score-list matches">
                            <h5>&#10003; Top Matches</h5>
                            <ul id="qs-matches"></ul>
                        </div>
                        <div class="quick-score-list gaps">
                            <h5>&#9888; Key Gaps</h5>
                            <ul id="qs-gaps"></ul>
                        </div>
                    </div>
                    <div class="quick-score-recommendation" id="qs-recommendation">
                        Recommendation text here
                    </div>
                    <button class="btn-clear-score" onclick="clearQuickScore()">Clear Result</button>
                </div>
            </div>
        </section>

        <!-- Progress Section -->
        <section id="progress-section" class="card hidden">
            <h2>Processing Your Application</h2>
            <div class="progress-bar">
                <div class="progress-bar-fill" id="progress-fill" style="width: 0%"></div>
            </div>
            <div class="steps" id="steps-container">
                <div class="step" data-step="rinser">
                    <div class="step-icon step-pending" id="step-icon-rinser">1</div>
                    <span class="step-label inactive" id="step-label-rinser">Processing job posting...</span>
                    <span class="step-duration" id="step-duration-rinser"></span>
                </div>
                <div class="step" data-step="analyzer">
                    <div class="step-icon step-pending" id="step-icon-analyzer">2</div>
                    <span class="step-label inactive" id="step-label-analyzer">Analyzing compatibility...</span>
                    <span class="step-duration" id="step-duration-analyzer"></span>
                </div>
                <div class="step" data-step="creator">
                    <div class="step-icon step-pending" id="step-icon-creator">3</div>
                    <span class="step-label inactive" id="step-label-creator">Generating content...</span>
                    <span class="step-duration" id="step-duration-creator"></span>
                </div>
                <div class="step" data-step="formatter">
                    <div class="step-icon step-pending" id="step-icon-formatter">4</div>
                    <span class="step-label inactive" id="step-label-formatter">Creating PDFs...</span>
                    <span class="step-duration" id="step-duration-formatter"></span>
                </div>
            </div>
        </section>

        <!-- Results Section -->
        <section id="result-section" class="card hidden">
            <div class="result-header">
                <div>
                    <h3 id="result-title">Software Engineer</h3>
                    <p id="result-company">Company Name</p>
                </div>
                <div class="score-badge" id="score-badge">85%</div>
            </div>
            <div class="match-message" id="match-message">
                Match analysis message here
            </div>
            <div class="download-buttons">
                <a href="#" class="btn-download btn-cv" id="download-cv">
                    <span>Download CV</span>
                </a>
                <a href="#" class="btn-download btn-cover" id="download-cover">
                    <span>Download Cover Letter</span>
                </a>
            </div>
            <button id="reset-btn" class="btn btn-secondary btn-block">
                Process Another Job
            </button>
        </section>

        <!-- Error Section -->
        <section id="error-section" class="card error-card hidden">
            <h3>Processing Failed</h3>
            <p id="error-message">Error details here</p>
            <div style="margin-top: 1rem;">
                <button id="retry-btn" class="btn btn-secondary">
                    Try Again
                </button>
            </div>
        </section>
    </main>

    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>

    <script src="/static/js/common.js"></script>
    <script>
        // =====================================================================
        // DASHBOARD STATE
        // =====================================================================

        const STORAGE_KEY = 'scout_active_job';
        let currentJobId = null;
        let pollInterval = null;
        let profileExists = false;

        // DOM Elements
        const jobTextArea = document.getElementById('job-text');
        const charCount = document.getElementById('char-count');
        const submitBtn = document.getElementById('submit-btn');
        const quickScoreBtn = document.getElementById('quick-score-btn');
        const inputSection = document.getElementById('input-section');
        const progressSection = document.getElementById('progress-section');
        const resultSection = document.getElementById('result-section');
        const errorSection = document.getElementById('error-section');
        const progressFill = document.getElementById('progress-fill');
        const profileSelect = document.getElementById('profile-select');
        const quickScoreContainer = document.getElementById('quick-score-container');
        const quickScoreLoading = document.getElementById('quick-score-loading');
        const quickScoreResult = document.getElementById('quick-score-result');

        // Step mapping
        const stepOrder = ['rinser', 'analyzer', 'creator', 'formatter'];

        // =====================================================================
        // INITIALIZATION
        // =====================================================================

        document.addEventListener('DOMContentLoaded', () => {
            // Check profile status
            checkProfileStatus();

            // Character counter
            jobTextArea.addEventListener('input', updateCharCount);

            // Submit button
            submitBtn.addEventListener('click', startProcessing);

            // Quick score button
            quickScoreBtn.addEventListener('click', calculateQuickScore);

            // Reset/retry buttons
            document.getElementById('reset-btn').addEventListener('click', resetForm);
            document.getElementById('retry-btn').addEventListener('click', resetForm);

            // Update profile select after active profile loads
            // Wait a bit for common.js loadActiveProfile() to complete
            setTimeout(() => updateProfileSelect(), 800);

            // Check for active job (handle page refresh)
            checkActiveJob();
        });

        // =====================================================================
        // ACTIVE JOB RECOVERY
        // =====================================================================

        async function checkActiveJob() {
            // Check localStorage for an active job
            const storedJob = localStorage.getItem(STORAGE_KEY);
            if (!storedJob) return;

            try {
                const jobData = JSON.parse(storedJob);
                const jobId = jobData.job_id;
                const startedAt = new Date(jobData.started_at);

                // Check if job is too old (more than 30 minutes)
                const ageMinutes = (Date.now() - startedAt.getTime()) / 60000;
                if (ageMinutes > 30) {
                    localStorage.removeItem(STORAGE_KEY);
                    return;
                }

                // Check job status from API
                const response = await fetch(`/api/v1/jobs/${jobId}`);
                if (!response.ok) {
                    localStorage.removeItem(STORAGE_KEY);
                    return;
                }

                const status = await response.json();

                // If job is still running, restore the UI
                if (status.status === 'running' || status.status === 'pending') {
                    currentJobId = jobId;
                    inputSection.classList.add('hidden');
                    progressSection.classList.remove('hidden');
                    resultSection.classList.add('hidden');
                    errorSection.classList.add('hidden');
                    updateProgress(status);
                    startPolling();
                    showToast('info', 'Job Restored', 'Resuming progress tracking...');
                } else if (status.status === 'completed') {
                    currentJobId = jobId;
                    showResults(status);
                } else if (status.status === 'failed') {
                    currentJobId = jobId;
                    showError(status.error || 'Processing failed');
                }
            } catch (error) {
                console.error('Error checking active job:', error);
                localStorage.removeItem(STORAGE_KEY);
            }
        }

        function saveActiveJob(jobId) {
            const jobData = {
                job_id: jobId,
                started_at: new Date().toISOString()
            };
            localStorage.setItem(STORAGE_KEY, JSON.stringify(jobData));
        }

        function clearActiveJob() {
            localStorage.removeItem(STORAGE_KEY);
        }

        // =====================================================================
        // PROFILE FUNCTIONS
        // =====================================================================

        async function checkProfileStatus() {
            try {
                const response = await fetch('/api/v1/profile/status');
                if (!response.ok) {
                    throw new Error('Failed to check profile status');
                }

                const status = await response.json();
                profileExists = status.exists && status.is_indexed;

                const warningSection = document.getElementById('profile-warning-section');
                const statusSection = document.getElementById('profile-status-section');
                const statusText = document.getElementById('profile-status-text');

                if (!status.exists) {
                    // No profile - show warning, hide input
                    warningSection.classList.remove('hidden');
                    statusSection.classList.add('hidden');
                    inputSection.classList.add('hidden');
                    submitBtn.disabled = true;
                } else if (!status.is_indexed) {
                    // Profile exists but not indexed
                    warningSection.classList.add('hidden');
                    statusSection.classList.remove('hidden');
                    statusText.textContent = 'Profile needs indexing';
                    submitBtn.disabled = true;
                } else {
                    // Profile ready
                    warningSection.classList.add('hidden');
                    statusSection.classList.remove('hidden');
                    statusText.textContent = `Profile ready (${status.chunk_count} chunks)`;
                    inputSection.classList.remove('hidden');
                }
            } catch (error) {
                console.error('Profile status check failed:', error);
                // On error, assume profile might exist and show input
                inputSection.classList.remove('hidden');
            }
        }

        async function updateProfileSelect() {
            try {
                const response = await fetch('/api/v1/profiles');
                if (!response.ok) {
                    profileSelect.innerHTML = '<option value="">No profiles available</option>';
                    return;
                }

                const data = await response.json();
                const profiles = data.profiles || [];
                const activeProfile = window.Scout.activeProfile;

                if (profiles.length === 0) {
                    profileSelect.innerHTML = '<option value="">No profiles available</option>';
                    return;
                }

                profileSelect.innerHTML = '<option value="">Use active profile (default)</option>' +
                    profiles.map(profile => {
                        const isActive = activeProfile && profile.slug === activeProfile.slug;
                        const label = profile.name || profile.slug;
                        return `<option value="${escapeHtml(profile.slug)}"${isActive ? ' selected' : ''}>
                            ${escapeHtml(label)}${isActive ? ' (active)' : ''}
                        </option>`;
                    }).join('');
            } catch (error) {
                console.error('Failed to load profiles:', error);
                profileSelect.innerHTML = '<option value="">No profiles available</option>';
            }
        }

        // =====================================================================
        // FORM HANDLING
        // =====================================================================

        function updateCharCount() {
            const len = jobTextArea.value.length;
            charCount.textContent = `${len} characters`;

            if (len < 100) {
                charCount.classList.add('warning');
                charCount.textContent += ' (minimum 100 required)';
                submitBtn.disabled = true;
                quickScoreBtn.disabled = true;
            } else {
                charCount.classList.remove('warning');
                submitBtn.disabled = false;
                quickScoreBtn.disabled = false;
            }
        }

        async function startProcessing() {
            const jobText = jobTextArea.value.trim();
            if (jobText.length < 100) return;

            // Show progress section
            inputSection.classList.add('hidden');
            progressSection.classList.remove('hidden');
            resultSection.classList.add('hidden');
            errorSection.classList.add('hidden');

            // Reset progress UI
            resetProgressUI();

            try {
                // Submit job
                const response = await fetch('/api/v1/jobs/apply', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ job_text: jobText })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to start processing');
                }

                const data = await response.json();
                currentJobId = data.job_id;

                // Save to localStorage for page refresh recovery
                saveActiveJob(currentJobId);

                // Start polling
                startPolling();
            } catch (error) {
                showError(error.message);
            }
        }

        function resetProgressUI() {
            progressFill.style.width = '0%';
            stepOrder.forEach((step, index) => {
                const icon = document.getElementById(`step-icon-${step}`);
                const label = document.getElementById(`step-label-${step}`);
                const duration = document.getElementById(`step-duration-${step}`);
                icon.className = 'step-icon step-pending';
                icon.textContent = index + 1;
                label.classList.add('inactive');
                if (duration) duration.textContent = '';
            });
        }

        // =====================================================================
        // STATUS POLLING
        // =====================================================================

        function startPolling() {
            if (pollInterval) clearInterval(pollInterval);

            pollInterval = setInterval(async () => {
                try {
                    const response = await fetch(`/api/v1/jobs/${currentJobId}`);
                    if (!response.ok) {
                        throw new Error('Failed to get status');
                    }

                    const status = await response.json();
                    updateProgress(status);

                    if (status.status === 'completed' || status.status === 'failed') {
                        clearInterval(pollInterval);
                        pollInterval = null;

                        if (status.status === 'completed') {
                            showResults(status);
                        } else {
                            showError(status.error || 'Processing failed');
                        }
                    }
                } catch (error) {
                    console.error('Poll error:', error);
                }
            }, 1000);
        }

        function updateProgress(status) {
            // Count completed steps
            const completedSteps = status.steps ?
                status.steps.filter(s => s.status === 'completed').length : 0;
            const progress = (completedSteps / stepOrder.length) * 100;
            progressFill.style.width = `${progress}%`;

            // Update step icons
            stepOrder.forEach((stepName, index) => {
                const icon = document.getElementById(`step-icon-${stepName}`);
                const label = document.getElementById(`step-label-${stepName}`);
                const durationEl = document.getElementById(`step-duration-${stepName}`);
                const stepData = status.steps?.find(s => s.step === stepName);

                if (stepData) {
                    if (stepData.status === 'completed') {
                        icon.className = 'step-icon step-completed';
                        icon.innerHTML = '&#10003;';
                        label.classList.remove('inactive');
                        if (durationEl && stepData.duration_ms) {
                            durationEl.textContent = `${(stepData.duration_ms / 1000).toFixed(1)}s`;
                        }
                    } else if (stepData.status === 'running') {
                        icon.className = 'step-icon step-running spinner';
                        icon.innerHTML = '&#8635;';
                        label.classList.remove('inactive');
                    } else if (stepData.status === 'failed') {
                        icon.className = 'step-icon step-failed';
                        icon.innerHTML = '&#10007;';
                        label.classList.remove('inactive');
                    }
                } else if (status.current_step === stepName) {
                    icon.className = 'step-icon step-running spinner';
                    icon.innerHTML = '&#8635;';
                    label.classList.remove('inactive');
                }
            });
        }

        // =====================================================================
        // RESULTS
        // =====================================================================

        function showResults(status) {
            // Clear active job from localStorage
            clearActiveJob();

            progressSection.classList.add('hidden');
            resultSection.classList.remove('hidden');

            // Update content
            document.getElementById('result-title').textContent =
                status.job_title || 'Job Application';
            document.getElementById('result-company').textContent =
                status.company_name || '';

            // Score badge
            const score = Math.round(status.compatibility_score || 0);
            const scoreBadge = document.getElementById('score-badge');
            scoreBadge.textContent = `${score}%`;

            // Score styling
            let scoreClass, matchClass, matchText;
            if (score >= 85) {
                scoreClass = 'score-excellent';
                matchClass = 'match-excellent';
                matchText = 'Excellent Match! Strongly recommended to apply.';
            } else if (score >= 70) {
                scoreClass = 'score-strong';
                matchClass = 'match-strong';
                matchText = 'Strong Match! Good candidate for this role.';
            } else if (score >= 50) {
                scoreClass = 'score-moderate';
                matchClass = 'match-moderate';
                matchText = 'Moderate Match. Consider highlighting transferable skills.';
            } else {
                scoreClass = 'score-weak';
                matchClass = 'match-weak';
                matchText = 'Weak Match. May want to focus on other opportunities.';
            }

            scoreBadge.className = `score-badge ${scoreClass}`;
            const matchMessage = document.getElementById('match-message');
            matchMessage.className = `match-message ${matchClass}`;
            matchMessage.textContent = matchText;

            // Download links
            document.getElementById('download-cv').href =
                `/api/v1/jobs/${currentJobId}/download/cv`;
            document.getElementById('download-cover').href =
                `/api/v1/jobs/${currentJobId}/download/cover_letter`;
        }

        function showError(message) {
            // Clear active job from localStorage
            clearActiveJob();

            progressSection.classList.add('hidden');
            errorSection.classList.remove('hidden');
            document.getElementById('error-message').textContent = message;
        }

        function resetForm() {
            // Clear active job from localStorage
            clearActiveJob();

            currentJobId = null;
            inputSection.classList.remove('hidden');
            progressSection.classList.add('hidden');
            resultSection.classList.add('hidden');
            errorSection.classList.add('hidden');
            jobTextArea.value = '';
            updateCharCount();
            clearQuickScore();
        }

        // =====================================================================
        // QUICK SCORE
        // =====================================================================

        let quickScoreCountdown = null;
        const QUICK_SCORE_TIMEOUT_SECONDS = 300; // 5 minutes per step, matches backend

        async function calculateQuickScore() {
            const jobText = jobTextArea.value.trim();
            if (jobText.length < 100) return;

            // Show loading state
            quickScoreContainer.classList.remove('hidden');
            quickScoreLoading.classList.remove('hidden');
            quickScoreResult.classList.add('hidden');
            quickScoreBtn.disabled = true;
            submitBtn.disabled = true; // Disable generate button during quick score
            quickScoreBtn.textContent = 'Analyzing...';

            // Start countdown timer
            startQuickScoreCountdown();

            try {
                const response = await fetch('/api/v1/jobs/quick-score', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ job_text: jobText })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to calculate score');
                }

                const data = await response.json();
                displayQuickScore(data);
            } catch (error) {
                showToast('error', 'Quick Score Failed', error.message);
                quickScoreContainer.classList.add('hidden');
            } finally {
                stopQuickScoreCountdown();
                quickScoreBtn.disabled = false;
                quickScoreBtn.textContent = 'Quick Score';
                // Re-enable submit button only if text is long enough
                if (jobTextArea.value.length >= 100) {
                    submitBtn.disabled = false;
                }
            }
        }

        function startQuickScoreCountdown() {
            let remaining = QUICK_SCORE_TIMEOUT_SECONDS;
            const loadingText = document.getElementById('quick-score-loading-text');

            updateCountdownText(loadingText, remaining);

            quickScoreCountdown = setInterval(() => {
                remaining--;
                if (remaining <= 0) {
                    stopQuickScoreCountdown();
                    loadingText.textContent = 'Analysis timed out...';
                } else {
                    updateCountdownText(loadingText, remaining);
                }
            }, 1000);
        }

        function updateCountdownText(element, seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            const timeStr = mins > 0 ? `${mins}:${secs.toString().padStart(2, '0')}` : `${secs}s`;
            element.textContent = `Analyzing compatibility... (timeout: ${timeStr})`;
        }

        function stopQuickScoreCountdown() {
            if (quickScoreCountdown) {
                clearInterval(quickScoreCountdown);
                quickScoreCountdown = null;
            }
        }

        function displayQuickScore(data) {
            // Hide loading, show result
            quickScoreLoading.classList.add('hidden');
            quickScoreResult.classList.remove('hidden');

            // Update title and company
            document.getElementById('qs-job-title').textContent = data.job_title || 'Job Position';
            document.getElementById('qs-company').textContent = data.company_name || '';

            // Update score badge
            const score = Math.round(data.score || 0);
            const scoreBadge = document.getElementById('qs-score-badge');
            scoreBadge.textContent = `${score}%`;

            // Score styling
            let scoreClass;
            if (score >= 85) {
                scoreClass = 'score-excellent';
            } else if (score >= 70) {
                scoreClass = 'score-strong';
            } else if (score >= 50) {
                scoreClass = 'score-moderate';
            } else {
                scoreClass = 'score-weak';
            }
            scoreBadge.className = `score-badge ${scoreClass}`;

            // Update matches
            const matchesList = document.getElementById('qs-matches');
            const matches = data.top_matches || [];
            if (matches.length > 0) {
                matchesList.innerHTML = matches.map(m => `<li>${escapeHtml(m)}</li>`).join('');
            } else {
                matchesList.innerHTML = '<li>No strong matches found</li>';
            }

            // Update gaps
            const gapsList = document.getElementById('qs-gaps');
            const gaps = data.key_gaps || [];
            if (gaps.length > 0) {
                gapsList.innerHTML = gaps.map(g => `<li>${escapeHtml(g)}</li>`).join('');
            } else {
                gapsList.innerHTML = '<li>No significant gaps identified</li>';
            }

            // Update recommendation
            document.getElementById('qs-recommendation').textContent =
                data.recommendation || 'Consider applying based on your match score.';
        }

        function clearQuickScore() {
            stopQuickScoreCountdown();
            quickScoreContainer.classList.add('hidden');
            quickScoreLoading.classList.add('hidden');
            quickScoreResult.classList.add('hidden');
        }
    </script>
</body>
</html>
