<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scout - Manage Profiles</title>
    <link rel="stylesheet" href="/static/css/common.css">
    <style>
        /* Profiles Page Specific Styles */
        .controls-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            gap: 1rem;
            flex-wrap: wrap;
        }
        .sort-controls {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .sort-controls label {
            font-size: 0.9rem;
            color: #666;
        }
        .filter-controls {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        .filter-controls label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            color: #666;
            cursor: pointer;
        }

        /* Active profile banner */
        .active-banner {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            border: 2px solid #10b981;
            border-radius: 8px;
            padding: 1rem 1.25rem;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        .active-banner-icon {
            font-size: 1.5rem;
        }
        .active-banner-text {
            flex: 1;
        }
        .active-banner-text strong {
            color: #065f46;
        }
        .active-banner-text span {
            color: #047857;
            font-size: 0.9rem;
        }

        /* Profile cards */
        .profiles-grid {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .profile-card {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            padding: 1.25rem;
            display: flex;
            gap: 1rem;
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        .profile-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .profile-card.active {
            border-color: #10b981;
            background: linear-gradient(135deg, #fff 0%, #f0fdf4 100%);
        }
        .profile-card.archived {
            opacity: 0.7;
            background: #f9fafb;
        }
        .profile-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-top: 0.25rem;
            flex-shrink: 0;
        }
        .profile-indicator.active {
            background: #10b981;
        }
        .profile-indicator.inactive {
            background: #e5e7eb;
        }
        .profile-indicator.archived {
            background: #9ca3af;
        }
        .profile-content {
            flex: 1;
            min-width: 0;
        }
        .profile-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.5rem;
        }
        .profile-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1a1a1a;
        }
        .profile-title {
            color: #666;
            font-size: 0.9rem;
        }
        .profile-filename {
            color: #9ca3af;
            font-size: 0.8rem;
            font-family: monospace;
        }
        .profile-stats {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin: 0.75rem 0;
        }
        .stat {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.85rem;
            color: #666;
        }
        .stat-icon {
            font-size: 0.9rem;
        }
        .stat-value {
            font-weight: 600;
            color: #374151;
        }
        .profile-badges {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        .badge-active {
            background: #d1fae5;
            color: #065f46;
        }
        .badge-indexed {
            background: #dbeafe;
            color: #1e40af;
        }
        .badge-warning {
            background: #fef3c7;
            color: #92400e;
        }
        .badge-archived {
            background: #e5e7eb;
            color: #6b7280;
        }
        .profile-actions {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            align-items: flex-end;
        }
        .actions-row {
            display: flex;
            gap: 0.5rem;
        }

        /* Modal */
        .modal {
            max-width: 400px;
        }
        .modal p {
            color: #666;
            margin-bottom: 1.5rem;
        }
        .modal-actions {
            display: flex;
            gap: 0.75rem;
            justify-content: flex-end;
        }
    </style>
</head>
<body>
    {% include 'partials/navbar.html' %}

    <main class="container">
        <!-- Page Header -->
        <div class="page-header">
            <h2>Your Profiles</h2>
            <a href="/profiles/create" class="btn btn-primary">
                <span>+</span> New Profile
            </a>
        </div>

        <!-- Summary Stats -->
        <div class="summary-stats" id="summary-stats">
            <div class="summary-stat">
                <div class="summary-stat-value" id="stat-total">0</div>
                <div class="summary-stat-label">Total Profiles</div>
            </div>
            <div class="summary-stat">
                <div class="summary-stat-value" id="stat-archived">0</div>
                <div class="summary-stat-label">Archived</div>
            </div>
            <div class="summary-stat">
                <div class="summary-stat-value" id="stat-usage">0</div>
                <div class="summary-stat-label">Total Applications</div>
            </div>
        </div>

        <!-- Active Profile Banner -->
        <div class="active-banner hidden" id="active-banner">
            <span class="active-banner-icon">&#10003;</span>
            <div class="active-banner-text">
                <strong id="active-profile-name">No active profile</strong><br>
                <span id="active-profile-filename">-</span>
            </div>
        </div>

        <!-- Controls Bar -->
        <div class="controls-bar">
            <div class="sort-controls">
                <label>Sort by:</label>
                <select id="sort-select" onchange="loadProfiles()">
                    <option value="created">Created Date</option>
                    <option value="name">Name</option>
                    <option value="usage">Usage Count</option>
                    <option value="score">Avg Score</option>
                </select>
                <select id="sort-order" onchange="loadProfiles()">
                    <option value="desc">Descending</option>
                    <option value="asc">Ascending</option>
                </select>
            </div>
            <div class="filter-controls">
                <label>
                    <input type="checkbox" id="show-archived" onchange="loadProfiles()">
                    Show Archived
                </label>
            </div>
        </div>

        <!-- Loading State -->
        <div class="loading" id="loading-state">
            <div class="spinner"></div>
        </div>

        <!-- Empty State -->
        <div class="empty-state hidden" id="empty-state">
            <div class="empty-state-icon">&#128203;</div>
            <h3>No Profiles Yet</h3>
            <p>Create your first profile to start matching jobs and generating tailored applications.</p>
            <a href="/profiles/create" class="btn btn-primary">Create Your First Profile</a>
        </div>

        <!-- Profiles Grid -->
        <div class="profiles-grid hidden" id="profiles-grid">
            <!-- Profiles will be inserted here -->
        </div>
    </main>

    <!-- Delete Confirmation Modal -->
    <div class="modal-overlay" id="delete-modal">
        <div class="modal">
            <div class="modal-header">
                <h3>Delete Profile?</h3>
                <button class="modal-close" onclick="closeDeleteModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p>This will permanently delete <strong id="delete-filename"></strong>. This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeDeleteModal()">Cancel</button>
                <button class="btn btn-danger" id="confirm-delete-btn">Delete</button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>

    <script src="/static/js/common.js"></script>
    <script>
        // State
        let profiles = [];
        let activeProfile = null;
        let deleteTarget = null;

        // DOM Elements
        const loadingState = document.getElementById('loading-state');
        const emptyState = document.getElementById('empty-state');
        const profilesGrid = document.getElementById('profiles-grid');
        const activeBanner = document.getElementById('active-banner');

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadProfiles();
        });

        async function loadProfiles() {
            loadingState.classList.remove('hidden');
            emptyState.classList.add('hidden');
            profilesGrid.classList.add('hidden');

            try {
                // Use existing single-profile API
                const statusResponse = await fetch('/api/v1/profile/status');
                if (!statusResponse.ok) throw new Error('Failed to check profile status');

                const status = await statusResponse.json();

                if (status.exists) {
                    // Get the profile data
                    const profileResponse = await fetch('/api/v1/profile/retrieve');
                    if (profileResponse.ok) {
                        const profileData = await profileResponse.json();

                        // Create a single profile entry
                        profiles = [{
                            filename: 'profile.yaml',
                            profile_name: extractName(profileData.profile_text) || 'My Profile',
                            title: extractTitle(profileData.profile_text) || '',
                            is_indexed: status.is_indexed,
                            chunk_count: status.chunk_count || 0,
                            usage_count: 0,
                            avg_compatibility_score: null,
                            is_archived: false,
                            created_at: null,
                            updated_at: null
                        }];
                        activeProfile = 'profile.yaml';
                    }
                } else {
                    profiles = [];
                    activeProfile = null;
                }

                // Update stats
                document.getElementById('stat-total').textContent = profiles.length;
                document.getElementById('stat-archived').textContent = 0;
                document.getElementById('stat-usage').textContent = 0;

                // Update active banner
                if (activeProfile && profiles.length > 0) {
                    activeBanner.classList.remove('hidden');
                    document.getElementById('active-profile-name').textContent =
                        profiles[0].profile_name || 'Profile';
                    document.getElementById('active-profile-filename').textContent =
                        profiles[0].filename;
                } else {
                    activeBanner.classList.add('hidden');
                }

                loadingState.classList.add('hidden');

                if (profiles.length === 0) {
                    emptyState.classList.remove('hidden');
                } else {
                    profilesGrid.classList.remove('hidden');
                    renderProfiles();
                }

            } catch (error) {
                console.error('Error loading profiles:', error);
                loadingState.classList.add('hidden');
                showToast('error', 'Error', 'Failed to load profiles');
            }
        }

        // Helper to extract name from profile text
        function extractName(text) {
            if (!text) return null;
            const match = text.match(/^name:\s*["']?([^"'\n]+)["']?/mi);
            return match ? match[1].trim() : null;
        }

        // Helper to extract title from profile text
        function extractTitle(text) {
            if (!text) return null;
            const match = text.match(/^title:\s*["']?([^"'\n]+)["']?/mi);
            return match ? match[1].trim() : null;
        }

        function renderProfiles() {
            profilesGrid.innerHTML = profiles.map(profile => {
                const isActive = profile.filename === activeProfile;
                const cardClass = isActive ? 'active' : (profile.is_archived ? 'archived' : '');
                const indicatorClass = isActive ? 'active' : (profile.is_archived ? 'archived' : 'inactive');

                return `
                    <div class="profile-card ${cardClass}" data-filename="${escapeHtml(profile.filename)}">
                        <div class="profile-indicator ${indicatorClass}"></div>
                        <div class="profile-content">
                            <div class="profile-header">
                                <div>
                                    <div class="profile-name">${escapeHtml(profile.profile_name || 'Unnamed Profile')}</div>
                                    <div class="profile-title">${escapeHtml(profile.title || '')}</div>
                                    <div class="profile-filename">${escapeHtml(profile.filename)}</div>
                                </div>
                            </div>
                            <div class="profile-stats">
                                <div class="stat">
                                    <span class="stat-icon">&#128200;</span>
                                    <span><span class="stat-value">${profile.chunk_count || 0}</span> chunks</span>
                                </div>
                                <div class="stat">
                                    <span class="stat-icon">&#128202;</span>
                                    <span><span class="stat-value">${profile.usage_count || 0}</span> uses</span>
                                </div>
                                ${profile.avg_compatibility_score ? `
                                <div class="stat">
                                    <span class="stat-icon">&#9734;</span>
                                    <span><span class="stat-value">${profile.avg_compatibility_score.toFixed(1)}%</span> avg score</span>
                                </div>
                                ` : ''}
                            </div>
                            <div class="profile-badges">
                                ${isActive ? '<span class="badge badge-active">Active</span>' : ''}
                                ${profile.is_indexed ? '<span class="badge badge-indexed">Indexed</span>' : '<span class="badge badge-warning">Needs Indexing</span>'}
                                ${profile.is_archived ? '<span class="badge badge-archived">Archived</span>' : ''}
                            </div>
                        </div>
                        <div class="profile-actions">
                            <div class="actions-row">
                                <a href="/profiles/create" class="btn btn-sm btn-secondary">View / Edit</a>
                                <button class="btn btn-sm btn-secondary" onclick="reindexProfile()">Re-index</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function reindexProfile() {
            try {
                showToast('info', 'Indexing', 'Re-indexing profile...');

                // First get the profile ID from status
                const statusResponse = await fetch('/api/v1/profile/status');
                if (!statusResponse.ok) throw new Error('Failed to get profile status');
                const status = await statusResponse.json();

                if (!status.profile_id) {
                    throw new Error('No profile found to reindex');
                }

                // Then reindex using the profile ID
                const response = await fetch('/api/v1/profile/index', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ profile_id: status.profile_id })
                });
                if (!response.ok) throw new Error('Failed to reindex profile');

                const data = await response.json();
                showToast('success', 'Indexed', `Created ${data.chunks_created} chunks`);
                loadProfiles();
            } catch (error) {
                console.error('Error reindexing profile:', error);
                showToast('error', 'Error', 'Failed to reindex profile');
            }
        }

        function showDeleteModal(filename) {
            deleteTarget = filename;
            document.getElementById('delete-filename').textContent = filename;
            document.getElementById('delete-modal').classList.add('show');

            document.getElementById('confirm-delete-btn').onclick = async () => {
                await deleteProfile(filename);
                closeDeleteModal();
            };
        }

        function closeDeleteModal() {
            document.getElementById('delete-modal').classList.remove('show');
            deleteTarget = null;
        }

        async function deleteProfile(filename) {
            try {
                const response = await fetch(`/api/v1/profiles/${encodeURIComponent(filename)}?confirm=true`, {
                    method: 'DELETE'
                });
                if (!response.ok) throw new Error('Failed to delete profile');

                showToast('success', 'Deleted', `${filename} has been deleted`);
                loadProfiles();
            } catch (error) {
                console.error('Error deleting profile:', error);
                showToast('error', 'Error', 'Failed to delete profile');
            }
        }
    </script>
</body>
</html>
