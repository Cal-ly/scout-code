<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scout - Manage Profiles</title>
    <link rel="stylesheet" href="/static/css/common.css">
    <style>
        /* Page-specific styles */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        .page-header h2 {
            margin: 0;
        }

        /* Summary stats row */
        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        .summary-stat {
            background: #fff;
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .summary-stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #2563eb;
        }
        .summary-stat-label {
            font-size: 0.85rem;
            color: #666;
        }

        /* Active profile banner */
        .active-banner {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            border: 2px solid #10b981;
            border-radius: 8px;
            padding: 1rem 1.25rem;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        .active-banner-icon {
            font-size: 1.5rem;
        }
        .active-banner-text {
            flex: 1;
        }
        .active-banner-text strong {
            color: #065f46;
        }
        .active-banner-text .subtitle {
            color: #047857;
            font-size: 0.9rem;
        }

        /* Profile cards */
        .profiles-grid {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .profile-card {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            padding: 1.25rem;
            display: flex;
            gap: 1rem;
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        .profile-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .profile-card.active {
            border-color: #10b981;
            background: linear-gradient(135deg, #fff 0%, #f0fdf4 100%);
        }

        .profile-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-top: 0.25rem;
            flex-shrink: 0;
        }
        .profile-indicator.active { background: #10b981; }
        .profile-indicator.inactive { background: #e5e7eb; }

        .profile-content {
            flex: 1;
            min-width: 0;
        }
        .profile-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.5rem;
            gap: 1rem;
        }
        .profile-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1a1a1a;
        }
        .profile-title {
            color: #666;
            font-size: 0.9rem;
        }
        .profile-slug {
            color: #9ca3af;
            font-size: 0.8rem;
            font-family: monospace;
        }

        /* Completeness indicator */
        .completeness-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.35rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        .completeness-indicator.excellent {
            background: #d1fae5;
            color: #065f46;
        }
        .completeness-indicator.good {
            background: #dbeafe;
            color: #1e40af;
        }
        .completeness-indicator.fair {
            background: #fef3c7;
            color: #92400e;
        }
        .completeness-indicator.needs_work {
            background: #fee2e2;
            color: #991b1b;
        }

        .profile-stats {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin: 0.75rem 0;
        }
        .stat {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.85rem;
            color: #666;
        }
        .stat-icon {
            font-size: 0.9rem;
        }
        .stat-value {
            font-weight: 600;
            color: #374151;
        }

        .profile-badges {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        .badge {
            font-size: 0.75rem;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-weight: 500;
        }
        .badge-active {
            background: #d1fae5;
            color: #065f46;
        }
        .badge-demo {
            background: #e5e7eb;
            color: #6b7280;
        }

        .profile-actions {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            align-items: flex-end;
        }
        .actions-row {
            display: flex;
            gap: 0.5rem;
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 3rem;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
        .empty-state h3 {
            color: #374151;
            margin-bottom: 0.5rem;
        }
        .empty-state p {
            color: #6b7280;
            margin-bottom: 1.5rem;
        }

        /* Delete modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal-overlay.show {
            display: flex;
        }
        .modal {
            background: #fff;
            border-radius: 8px;
            padding: 1.5rem;
            max-width: 400px;
            width: 90%;
        }
        .modal h3 {
            margin: 0 0 1rem 0;
        }
        .modal p {
            color: #666;
            margin-bottom: 1.5rem;
        }
        .modal-actions {
            display: flex;
            gap: 0.75rem;
            justify-content: flex-end;
        }

        .hidden { display: none !important; }
    </style>
</head>
<body>
    {% include 'partials/navbar.html' %}

    <main class="container">
        <!-- Page Header -->
        <div class="page-header">
            <h2>Your Profiles</h2>
            <a href="/profiles/new" class="btn btn-primary">+ Create Profile</a>
        </div>

        <!-- Summary Stats -->
        <div class="summary-stats" id="summary-stats">
            <div class="summary-stat">
                <div class="summary-stat-value" id="stat-total">0</div>
                <div class="summary-stat-label">Total Profiles</div>
            </div>
            <div class="summary-stat">
                <div class="summary-stat-value" id="stat-active-score">-</div>
                <div class="summary-stat-label">Active Profile Score</div>
            </div>
            <div class="summary-stat">
                <div class="summary-stat-value" id="stat-applications">0</div>
                <div class="summary-stat-label">Total Applications</div>
            </div>
        </div>

        <!-- Active Profile Banner -->
        <div class="active-banner hidden" id="active-banner">
            <span class="active-banner-icon">&#10003;</span>
            <div class="active-banner-text">
                <strong id="active-profile-name">No active profile</strong><br>
                <span class="subtitle" id="active-profile-title">-</span>
            </div>
            <a href="#" id="active-profile-edit-link" class="btn btn-sm btn-secondary">Edit</a>
        </div>

        <!-- Loading State -->
        <div class="loading" id="loading-state">
            <div class="spinner"></div>
        </div>

        <!-- Empty State -->
        <div class="empty-state hidden" id="empty-state">
            <div class="empty-state-icon">&#128203;</div>
            <h3>No Profiles Yet</h3>
            <p>Create your first profile to start matching jobs and generating tailored applications.</p>
            <a href="/profiles/new" class="btn btn-primary">Create Your First Profile</a>
        </div>

        <!-- Profiles Grid -->
        <div class="profiles-grid hidden" id="profiles-grid">
            <!-- Profiles will be inserted here by JS -->
        </div>
    </main>

    <!-- Delete Confirmation Modal -->
    <div class="modal-overlay" id="delete-modal">
        <div class="modal">
            <h3>Delete Profile?</h3>
            <p>This will permanently delete <strong id="delete-profile-name"></strong> and all its data. This action cannot be undone.</p>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeDeleteModal()">Cancel</button>
                <button class="btn btn-danger" id="confirm-delete-btn">Delete</button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>

    <script src="/static/js/common.js"></script>
    <script>
        // State
        let profiles = [];
        let activeProfile = null;
        let deleteTargetSlug = null;

        // DOM Elements
        const loadingState = document.getElementById('loading-state');
        const emptyState = document.getElementById('empty-state');
        const profilesGrid = document.getElementById('profiles-grid');
        const activeBanner = document.getElementById('active-banner');

        // Initialize
        document.addEventListener('DOMContentLoaded', loadProfiles);

        async function loadProfiles() {
            loadingState.classList.remove('hidden');
            emptyState.classList.add('hidden');
            profilesGrid.classList.add('hidden');

            try {
                const response = await fetch('/api/v1/profiles');
                if (!response.ok) throw new Error('Failed to load profiles');

                const data = await response.json();
                profiles = data.profiles || [];
                activeProfile = profiles.find(p => p.is_active) || null;

                // Update stats
                document.getElementById('stat-total').textContent = profiles.length;

                // Calculate total applications
                const totalApps = profiles.reduce((sum, p) => sum + (p.stats?.application_count || 0), 0);
                document.getElementById('stat-applications').textContent = totalApps;

                // Update active banner
                if (activeProfile) {
                    activeBanner.classList.remove('hidden');
                    document.getElementById('active-profile-name').textContent = activeProfile.name;
                    document.getElementById('active-profile-title').textContent = activeProfile.title || 'No title set';
                    document.getElementById('active-profile-edit-link').href = `/profiles/${activeProfile.slug}/edit`;

                    // Fetch completeness for active profile
                    try {
                        const compResponse = await fetch(`/api/v1/profiles/${activeProfile.slug}/completeness`);
                        if (compResponse.ok) {
                            const comp = await compResponse.json();
                            document.getElementById('stat-active-score').textContent = `${comp.overall_score}%`;
                        }
                    } catch (e) {
                        console.warn('Could not fetch completeness:', e);
                    }
                } else {
                    activeBanner.classList.add('hidden');
                    document.getElementById('stat-active-score').textContent = '-';
                }

                loadingState.classList.add('hidden');

                if (profiles.length === 0) {
                    emptyState.classList.remove('hidden');
                } else {
                    profilesGrid.classList.remove('hidden');
                    await renderProfiles();
                }

            } catch (error) {
                console.error('Error loading profiles:', error);
                loadingState.classList.add('hidden');
                showToast('error', 'Error', 'Failed to load profiles');
            }
        }

        async function renderProfiles() {
            // Fetch completeness for all profiles
            const completenessMap = {};
            await Promise.all(profiles.map(async (profile) => {
                try {
                    const response = await fetch(`/api/v1/profiles/${profile.slug}/completeness`);
                    if (response.ok) {
                        completenessMap[profile.slug] = await response.json();
                    }
                } catch (e) {
                    console.warn(`Could not fetch completeness for ${profile.slug}`);
                }
            }));

            profilesGrid.innerHTML = profiles.map(profile => {
                const isActive = profile.is_active;
                const comp = completenessMap[profile.slug];
                const stats = profile.stats || {};

                return `
                    <div class="profile-card ${isActive ? 'active' : ''}" data-slug="${escapeHtml(profile.slug)}">
                        <div class="profile-indicator ${isActive ? 'active' : 'inactive'}"></div>
                        <div class="profile-content">
                            <div class="profile-header">
                                <div>
                                    <div class="profile-name">${escapeHtml(profile.name)}</div>
                                    <div class="profile-title">${escapeHtml(profile.title || 'No title')}</div>
                                    <div class="profile-slug">${escapeHtml(profile.slug)}</div>
                                </div>
                                ${comp ? `
                                    <div class="completeness-indicator ${comp.level}">
                                        ${comp.overall_score}% ${capitalizeFirst(comp.level.replace('_', ' '))}
                                    </div>
                                ` : ''}
                            </div>
                            <div class="profile-stats">
                                <div class="stat">
                                    <span class="stat-icon">&#128736;</span>
                                    <span><span class="stat-value">${stats.skill_count || 0}</span> skills</span>
                                </div>
                                <div class="stat">
                                    <span class="stat-icon">&#128188;</span>
                                    <span><span class="stat-value">${stats.experience_count || 0}</span> experiences</span>
                                </div>
                                <div class="stat">
                                    <span class="stat-icon">&#127891;</span>
                                    <span><span class="stat-value">${stats.education_count || 0}</span> education</span>
                                </div>
                                <div class="stat">
                                    <span class="stat-icon">&#128196;</span>
                                    <span><span class="stat-value">${stats.application_count || 0}</span> applications</span>
                                </div>
                                ${stats.avg_compatibility_score ? `
                                    <div class="stat">
                                        <span class="stat-icon">&#11088;</span>
                                        <span><span class="stat-value">${stats.avg_compatibility_score.toFixed(0)}%</span> avg score</span>
                                    </div>
                                ` : ''}
                            </div>
                            <div class="profile-badges">
                                ${isActive ? '<span class="badge badge-active">Active</span>' : ''}
                                ${profile.is_demo ? '<span class="badge badge-demo">Demo</span>' : ''}
                            </div>
                        </div>
                        <div class="profile-actions">
                            <div class="actions-row">
                                <a href="/profiles/${escapeHtml(profile.slug)}/edit" class="btn btn-sm btn-primary">Edit</a>
                                ${!isActive ? `
                                    <button class="btn btn-sm btn-secondary" onclick="activateProfile('${escapeHtml(profile.slug)}')">
                                        Set Active
                                    </button>
                                ` : ''}
                            </div>
                            <div class="actions-row">
                                ${!isActive ? `
                                    <button class="btn btn-sm btn-danger-outline" onclick="showDeleteModal('${escapeHtml(profile.slug)}', '${escapeHtml(profile.name)}')">
                                        Delete
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function activateProfile(slug) {
            try {
                showToast('info', 'Activating', 'Setting profile as active...');

                const response = await fetch(`/api/v1/profiles/${encodeURIComponent(slug)}/activate`, {
                    method: 'POST'
                });

                if (!response.ok) throw new Error('Failed to activate profile');

                const result = await response.json();
                showToast('success', 'Activated', result.message);

                // Reload to show updated state
                await loadProfiles();

            } catch (error) {
                console.error('Error activating profile:', error);
                showToast('error', 'Error', 'Failed to activate profile');
            }
        }

        function showDeleteModal(slug, name) {
            deleteTargetSlug = slug;
            document.getElementById('delete-profile-name').textContent = name;
            document.getElementById('delete-modal').classList.add('show');

            document.getElementById('confirm-delete-btn').onclick = async () => {
                await deleteProfile(slug);
                closeDeleteModal();
            };
        }

        function closeDeleteModal() {
            document.getElementById('delete-modal').classList.remove('show');
            deleteTargetSlug = null;
        }

        async function deleteProfile(slug) {
            try {
                const response = await fetch(`/api/v1/profiles/${encodeURIComponent(slug)}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to delete');
                }

                showToast('success', 'Deleted', 'Profile has been deleted');
                await loadProfiles();

            } catch (error) {
                console.error('Error deleting profile:', error);
                showToast('error', 'Error', error.message || 'Failed to delete profile');
            }
        }
    </script>
</body>
</html>
